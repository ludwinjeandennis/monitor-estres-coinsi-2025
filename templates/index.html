<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Estr√©s Acad√©mico - COINSI 2025</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .status-section {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .stress-indicator {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
        }

        .stress-icon {
            font-size: 80px;
            margin: 20px 0;
        }

        .stress-label {
            font-size: 32px;
            font-weight: bold;
            text-transform: uppercase;
            margin-top: 10px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .metric-card {
            background: #f8fafc;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .metric-value {
            font-size: 28px;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 14px;
            color: #64748b;
            text-transform: uppercase;
        }

        .probabilities {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }

        .prob-bar {
            flex: 1;
            text-align: center;
        }

        .prob-label {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .prob-fill {
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            transition: all 0.3s;
        }

        .prob-bajo { background: #4ade80; }
        .prob-medio { background: #fbbf24; }
        .prob-alto { background: #f87171; }

        .controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #4ade80;
            color: #1e293b;
        }

        .btn-primary:hover:not(:disabled) {
            background: #22c55e;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #f87171;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #ef4444;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #64748b;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #475569;
            transform: translateY(-2px);
        }

        .recommendation {
            background: #fef3c7;
            border-left: 4px solid #fbbf24;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .recommendation h3 {
            color: #92400e;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .recommendation p {
            color: #78350f;
            line-height: 1.6;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-active { background: #4ade80; }
        .status-inactive { background: #94a3b8; }

        .info-text {
            text-align: center;
            color: #64748b;
            margin: 20px 0;
            font-size: 14px;
        }

        .debug-info {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #475569;
        }

        .footer {
            text-align: center;
            color: white;
            margin-top: 30px;
            opacity: 0.9;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .monitoring-active {
            animation: pulse 2s infinite;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }

        .alert-success {
            background: #dcfce7;
            color: #166534;
            border-left: 4px solid #22c55e;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid #fbbf24;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† Monitor de Estr√©s Acad√©mico</h1>
            <p>Sistema de Detecci√≥n en Tiempo Real - COINSI 2025 UNAP</p>
        </div>

        <div class="main-card">
            <div class="alert alert-info" id="instructionAlert">
                üìã <strong>Instrucciones:</strong> Haz clic en "Iniciar Monitoreo", luego usa tu teclado y mouse normalmente durante 30 segundos antes de analizar.
            </div>

            <div class="info-text" id="statusText">
                <span class="status-indicator status-inactive"></span>
                Haz clic en "Iniciar Monitoreo" para comenzar
            </div>

            <div class="controls">
                <button class="btn btn-primary" id="startBtn" onclick="startMonitoring()">
                    ‚ñ∂Ô∏è Iniciar Monitoreo
                </button>
                <button class="btn btn-danger" id="stopBtn" onclick="stopMonitoring()" style="display: none;">
                    ‚è∏Ô∏è Detener
                </button>
                <button class="btn btn-secondary" id="analyzeBtn" onclick="analyzeNow()" disabled>
                    üîÑ Analizar Ahora
                </button>
            </div>

            <div class="debug-info" id="debugInfo">
                üìä Eventos capturados: Teclas: 0 | Mouse: 0 | Clicks: 0
            </div>
        </div>

        <div class="main-card" id="resultsSection" style="display: none;">
            <div class="status-section">
                <div class="stress-indicator">
                    <div>Estado Actual</div>
                    <div class="stress-icon" id="stressIcon">üü°</div>
                    <div class="stress-label" id="stressLabel">MEDIO</div>
                </div>

                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="keysPerMin">0</div>
                        <div class="metric-label">Teclas/Minuto</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="errorRate">0%</div>
                        <div class="metric-label">Tasa de Error</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="clicksPerMin">0</div>
                        <div class="metric-label">Clicks/Minuto</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="mouseSpeed">0</div>
                        <div class="metric-label">Velocidad Mouse</div>
                    </div>
                </div>
            </div>

            <div class="probabilities">
                <div class="prob-bar">
                    <div class="prob-label">Bajo</div>
                    <div class="prob-fill prob-bajo" id="probBajo">33%</div>
                </div>
                <div class="prob-bar">
                    <div class="prob-label">Medio</div>
                    <div class="prob-fill prob-medio" id="probMedio">34%</div>
                </div>
                <div class="prob-bar">
                    <div class="prob-label">Alto</div>
                    <div class="prob-fill prob-alto" id="probAlto">33%</div>
                </div>
            </div>

            <div class="recommendation" id="recommendation">
                <h3>
                    <span>üí°</span>
                    <span>Recomendaci√≥n</span>
                </h3>
                <p id="recommendationText">Considera hacer una pausa breve de 5-10 minutos.</p>
            </div>
        </div>

        <div class="footer">
            <p>COINSI 2025 - Escuela Profesional de Ingenier√≠a de Sistemas</p>
            <p>Universidad Nacional del Altiplano - Puno</p>
        </div>
    </div>

    <script>
        // Configuraci√≥n - DETECTA AUTOM√ÅTICAMENTE EL ENTORNO
        const API_URL = '/api';
        
        console.log('üöÄ Aplicaci√≥n iniciada');
        console.log('üì° API URL:', API_URL);

        let isMonitoring = false;
        let sessionId = null;
        let monitoringInterval = null;
        let updateDebugInterval = null;
        let startTime = null;
        
        // Almacenamiento de eventos
        let events = {
            keys: [],
            mouse: [],
            clicks: 0,
            lastMousePos: { x: 0, y: 0, time: Date.now() }
        };

        // Recomendaciones por nivel
        const recommendations = {
            0: '¬°Excelente! Mant√©n este ritmo de trabajo. Est√°s en tu zona √≥ptima de productividad.',
            1: 'Considera hacer una pausa breve de 5-10 minutos. Camina un poco o toma agua.',
            2: '‚ö†Ô∏è TOMA UN DESCANSO AHORA. Date 10-15 minutos para relajarte. Tu bienestar es importante.'
        };

        // Verificar conexi√≥n al cargar
        window.addEventListener('load', async () => {
            try {
                const response = await fetch(`${API_URL}/test`);
                const data = await response.json();
                console.log('‚úÖ Conexi√≥n con API exitosa:', data);
                
                if (!data.model_loaded) {
                    showAlert('‚ö†Ô∏è Modelo ML no disponible. Las predicciones ser√°n aproximadas.', 'warning');
                }
            } catch (error) {
                console.error('‚ùå Error al conectar con API:', error);
                showAlert('‚ö†Ô∏è No se pudo conectar con el servidor. Verifica que est√© ejecut√°ndose.', 'warning');
            }
        });

        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const container = document.querySelector('.container');
            const firstCard = container.querySelector('.main-card');
            container.insertBefore(alertDiv, firstCard);
            
            setTimeout(() => alertDiv.remove(), 5000);
        }

        // Actualizar contador de eventos
        function updateDebugInfo() {
            const elapsed = startTime ? Math.floor((Date.now() - startTime) / 1000) : 0;
            document.getElementById('debugInfo').innerHTML = 
                `üìä Eventos capturados: Teclas: <strong>${events.keys.length}</strong> | ` +
                `Mouse: <strong>${events.mouse.length}</strong> | ` +
                `Clicks: <strong>${events.clicks}</strong> | ` +
                `Tiempo: <strong>${elapsed}s</strong>`;
        }

        // Iniciar monitoreo
        async function startMonitoring() {
            isMonitoring = true;
            sessionId = Date.now().toString();
            startTime = Date.now();
            
            console.log('‚ñ∂Ô∏è Iniciando monitoreo, sessionId:', sessionId);
            
            // Resetear eventos
            events = {
                keys: [],
                mouse: [],
                clicks: 0,
                lastMousePos: { x: 0, y: 0, time: Date.now() }
            };
            
            // Actualizar UI
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'block';
            document.getElementById('analyzeBtn').disabled = false;
            document.getElementById('instructionAlert').style.display = 'none';
            document.getElementById('statusText').innerHTML = 
                '<span class="status-indicator status-active monitoring-active"></span>' +
                'Monitoreando activamente... Usa tu teclado y mouse';
            
            // Iniciar sesi√≥n en el servidor
            try {
                const response = await fetch(`${API_URL}/start_session`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });
                const data = await response.json();
                console.log('‚úÖ Sesi√≥n iniciada:', data);
            } catch (error) {
                console.error('‚ùå Error al iniciar sesi√≥n:', error);
            }
            
            // Capturar eventos - M√âTODO MEJORADO
            document.addEventListener('keydown', captureKeyEvent, true);
            document.addEventListener('keyup', captureKeyUpEvent, true);
            document.addEventListener('mousemove', captureMouseEvent, true);
            document.addEventListener('click', captureClickEvent, true);
            
            // Actualizar debug cada segundo
            updateDebugInterval = setInterval(updateDebugInfo, 1000);
            
            // An√°lisis autom√°tico cada 2 minutos
            monitoringInterval = setInterval(analyzeNow, 120000);
            
            console.log('‚úÖ Event listeners activados');
        }

        // Detener monitoreo
        function stopMonitoring() {
            isMonitoring = false;
            
            console.log('‚è∏Ô∏è Deteniendo monitoreo');
            
            // Limpiar eventos
            document.removeEventListener('keydown', captureKeyEvent, true);
            document.removeEventListener('keyup', captureKeyUpEvent, true);
            document.removeEventListener('mousemove', captureMouseEvent, true);
            document.removeEventListener('click', captureClickEvent, true);
            
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
            
            if (updateDebugInterval) {
                clearInterval(updateDebugInterval);
                updateDebugInterval = null;
            }
            
            // Actualizar UI
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('statusText').innerHTML = 
                '<span class="status-indicator status-inactive"></span>Monitoreo detenido';
            
            startTime = null;
            updateDebugInfo();
        }

        // Capturar teclas (keydown)
        function captureKeyEvent(e) {
            if (!isMonitoring) return;
            
            const isError = e.key === 'Backspace' || e.key === 'Delete';
            
            events.keys.push({
                timestamp: Date.now(),
                key: e.key,
                isError: isError
            });
            
            if (events.keys.length % 10 === 0) {
                console.log(`‚å®Ô∏è ${events.keys.length} teclas capturadas`);
            }
        }

        // Capturar teclas (keyup) - para mejor precisi√≥n
        function captureKeyUpEvent(e) {
            if (!isMonitoring) return;
            // Solo registrar para c√°lculos adicionales si es necesario
        }

        // Capturar movimiento del mouse
        function captureMouseEvent(e) {
            if (!isMonitoring) return;
            
            const now = Date.now();
            const dx = e.clientX - events.lastMousePos.x;
            const dy = e.clientY - events.lastMousePos.y;
            const distance = Math.sqrt(dx*dx + dy*dy);
            const timeDiff = (now - events.lastMousePos.time) / 1000; // en segundos
            const speed = timeDiff > 0 ? distance / timeDiff : 0;
            
            if (distance > 5) { // Solo registrar si hay movimiento significativo
                events.mouse.push({
                    timestamp: now,
                    distance: distance,
                    speed: speed
                });
                
                if (events.mouse.length % 50 === 0) {
                    console.log(`üñ±Ô∏è ${events.mouse.length} movimientos de mouse capturados`);
                }
            }
            
            events.lastMousePos = { x: e.clientX, y: e.clientY, time: now };
        }

        // Capturar clicks
        function captureClickEvent(e) {
            if (!isMonitoring) return;
            events.clicks++;
            console.log(`üñ±Ô∏è Click #${events.clicks}`);
        }

        // Analizar ahora
        async function analyzeNow() {
            console.log('üîÑ Iniciando an√°lisis...');
            console.log('üìä Eventos:', {
                keys: events.keys.length,
                mouse: events.mouse.length,
                clicks: events.clicks
            });

            // Validaci√≥n mejorada
            if (events.keys.length < 5) {
                showAlert('‚ö†Ô∏è Necesitas escribir m√°s (al menos 5 teclas) para obtener una lectura precisa.', 'warning');
                return;
            }

            if (events.mouse.length < 5) {
                showAlert('‚ö†Ô∏è Necesitas mover el mouse m√°s para obtener una lectura precisa.', 'warning');
                return;
            }

            const features = calculateFeatures();
            console.log('üìà Features calculadas:', features);
            
            try {
                const response = await fetch(`${API_URL}/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        features: features
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('‚úÖ Resultado del an√°lisis:', result);
                
                updateUI(result, features);
                showAlert('‚úÖ An√°lisis completado exitosamente', 'success');
                
                // Resetear eventos despu√©s del an√°lisis
                events.keys = [];
                events.mouse = [];
                events.clicks = 0;
                startTime = Date.now();
                
            } catch (error) {
                console.error('‚ùå Error al analizar:', error);
                showAlert('‚ùå Error al analizar: ' + error.message, 'warning');
            }
        }

        // Calcular caracter√≠sticas
        function calculateFeatures() {
            const now = Date.now();
            const duration = startTime ? (now - startTime) / 1000 : 60; // en segundos
            
            console.log(`‚è±Ô∏è Duraci√≥n de la muestra: ${duration.toFixed(1)}s`);
            
            // Teclado
            const keyLatencies = [];
            for (let i = 1; i < events.keys.length; i++) {
                const latency = events.keys[i].timestamp - events.keys[i-1].timestamp;
                if (latency < 5000) { // Ignorar latencias > 5 segundos
                    keyLatencies.push(latency);
                }
            }
            
            const errors = events.keys.filter(k => k.isError).length;
            
            // Mouse
            const mouseSpeeds = events.mouse.map(m => m.speed).filter(s => s > 0 && s < 10000);
            const totalDistance = events.mouse.reduce((sum, m) => sum + m.distance, 0);
            
            const features = {
                keys_per_minute: (events.keys.length / duration) * 60,
                avg_key_latency: keyLatencies.length > 0 ? 
                    keyLatencies.reduce((a,b) => a+b, 0) / keyLatencies.length : 150,
                std_key_latency: calculateStd(keyLatencies),
                error_rate: events.keys.length > 0 ? errors / events.keys.length : 0,
                clicks_per_minute: (events.clicks / duration) * 60,
                total_mouse_distance: totalDistance,
                avg_mouse_speed: mouseSpeeds.length > 0 ?
                    mouseSpeeds.reduce((a,b) => a+b, 0) / mouseSpeeds.length : 300
            };
            
            // Ajustar valores por defecto si son muy bajos
            if (features.keys_per_minute < 1) features.keys_per_minute = 30;
            if (features.avg_mouse_speed < 1) features.avg_mouse_speed = 300;
            if (features.std_key_latency < 1) features.std_key_latency = 20;
            
            return features;
        }

        // Calcular desviaci√≥n est√°ndar
        function calculateStd(arr) {
            if (arr.length === 0) return 25;
            const mean = arr.reduce((a,b) => a+b, 0) / arr.length;
            const variance = arr.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / arr.length;
            return Math.sqrt(variance);
        }

        // Actualizar interfaz
        function updateUI(result, features) {
            document.getElementById('resultsSection').style.display = 'block';
            
            const icons = ['üü¢', 'üü°', 'üî¥'];
            const labels = ['BAJO', 'MEDIO', 'ALTO'];
            const stressLevel = result.stress_level || 1;
            
            document.getElementById('stressIcon').textContent = icons[stressLevel];
            document.getElementById('stressLabel').textContent = labels[stressLevel];
            
            // Probabilidades
            const probs = result.probabilities || { bajo: 0.33, medio: 0.34, alto: 0.33 };
            document.getElementById('probBajo').textContent = 
                (probs.bajo * 100).toFixed(0) + '%';
            document.getElementById('probMedio').textContent = 
                (probs.medio * 100).toFixed(0) + '%';
            document.getElementById('probAlto').textContent = 
                (probs.alto * 100).toFixed(0) + '%';
            
            // M√©tricas - usar las features calculadas localmente
            const displayFeatures = result.features_used || features;
            document.getElementById('keysPerMin').textContent = 
                displayFeatures.keys_per_minute.toFixed(0);
            document.getElementById('errorRate').textContent = 
                (displayFeatures.error_rate * 100).toFixed(1) + '%';
            document.getElementById('clicksPerMin').textContent = 
                displayFeatures.clicks_per_minute.toFixed(0);
            document.getElementById('mouseSpeed').textContent = 
                displayFeatures.avg_mouse_speed.toFixed(0);
            
            // Recomendaci√≥n
            document.getElementById('recommendation').style.display = 'block';
            document.getElementById('recommendationText').textContent = 
                recommendations[stressLevel] || recommendations[1];
        }

        // Inicializaci√≥n
        updateDebugInfo();
    </script>
</body>
</html>